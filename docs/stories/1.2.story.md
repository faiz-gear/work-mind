# Story 1.2: 用户认证系统

## Status

Draft

## Story

**As a** 用户,
**I want** 能够注册、登录和管理我的账户,
**so that** 安全地访问我的工作记录

## Acceptance Criteria

1. 实现用户注册功能（邮箱/密码）
2. 实现用户登录功能
3. 实现密码重置功能
4. 集成Supabase认证服务
5. 创建用户会话管理
6. 实现基本的用户资料管理

## Tasks / Subtasks

- [ ] Task 1: 设置Supabase Auth集成 (AC: 4)
  - [ ] 配置Supabase Auth中间件
  - [ ] 创建认证工具函数
  - [ ] 设置会话管理
  - [ ] 创建认证状态Provider
- [ ] Task 2: 实现用户注册功能 (AC: 1)
  - [ ] 创建注册API端点 (/api/auth/register/route.ts)
  - [ ] 创建注册页面 (app/(auth)/register/page.tsx)
  - [ ] 实现注册表单组件
  - [ ] 添加注册输入验证
- [ ] Task 3: 实现用户登录功能 (AC: 2)
  - [ ] 创建登录API端点 (/api/auth/login/route.ts)
  - [ ] 创建登录页面 (app/(auth)/login/page.tsx)
  - [ ] 实现登录表单组件
  - [ ] 添加登录状态管理
- [ ] Task 4: 实现密码重置功能 (AC: 3)
  - [ ] 创建密码重置API端点
  - [ ] 创建密码重置页面
  - [ ] 实现重置流程组件
  - [ ] 集成邮件发送功能
- [ ] Task 5: 创建用户会话管理 (AC: 5)
  - [ ] 实现会话刷新逻辑
  - [ ] 创建认证中间件
  - [ ] 添加路由保护功能
  - [ ] 实现自动登出机制
- [ ] Task 6: 实现用户资料管理 (AC: 6)
  - [ ] 创建用户资料API端点
  - [ ] 创建资料管理页面
  - [ ] 实现资料编辑功能
  - [ ] 添加头像上传功能

## Dev Notes

### Previous Story Insights

From Story 1.1, we have established the foundation with:

- Supabase client configuration in src/lib/supabase.ts
- Basic User model schema in src/lib/db/schema.ts
- Project structure following unified architecture patterns
- TypeScript configuration with strict mode enabled

### Data Models

User model already established: [Source: architecture/4-data-models.md#user]

- **User Model**: UUID primary key, email (VARCHAR 255), name (VARCHAR 100), avatar_url (TEXT), timestamps, preferences (JSONB)
- **User Interface**: Complete TypeScript interface defined with theme, language, notifications, ai_settings preferences
- **User Table Schema**: Already created in src/lib/db/schema.ts with proper UUID references and constraints

### API Specifications

Authentication endpoints to implement: [Source: architecture/11-backend-architecture.md#function-organization]

- **API Routes Structure**: src/app/api/auth/ with login/, register/, logout/ subdirectories
- **Authentication Pattern**: Supabase Auth integration with JWT tokens and HttpOnly cookies
- **Session Management**: createServerComponentClient for server-side auth, automatic token refresh
- **Error Handling**: Standard error handling with 401 Unauthorized responses
- **Middleware Integration**: Auth middleware for route protection and session validation

### Component Specifications

Frontend authentication components: [Source: architecture/10-frontend-architecture-app-router.md#component-organization]

- **Route Groups**: (auth) route group for authentication layouts at app/(auth)/
- **Auth Layout**: Dedicated authentication layout component at app/(auth)/layout.tsx
- **Page Components**: login/page.tsx, register/page.tsx for authentication flows
- **Auth Provider**: components/providers/auth-provider.tsx for authentication state
- **Form Components**: components/forms/auth-form.tsx for reusable authentication forms

### File Locations

Exact paths for authentication system: [Source: architecture/12-unified-project-structure.md]

```
src/app/
├── (auth)/                     # 认证路由组
│   ├── layout.tsx             # 认证布局
│   ├── login/
│   │   └── page.tsx           # 登录页面
│   ├── register/
│   │   └── page.tsx           # 注册页面
│   └── reset-password/
│       └── page.tsx           # 密码重置页面
├── api/
│   └── auth/
│       ├── login/
│       │   └── route.ts       # 登录API端点
│       ├── register/
│       │   └── route.ts       # 注册API端点
│       ├── logout/
│       │   └── route.ts       # 登出API端点
│       └── reset-password/
│           └── route.ts       # 密码重置API端点
├── components/
│   ├── forms/
│   │   └── auth-form.tsx      # 认证表单组件
│   └── providers/
│       └── auth-provider.tsx  # 认证状态Provider
├── lib/
│   ├── auth.ts                # 认证工具函数
│   └── middleware/
│       └── auth.ts            # 认证中间件
├── hooks/
│   └── use-auth.ts            # 认证相关Hooks
└── stores/
    └── auth.store.ts          # 认证状态管理
```

### Testing Requirements

Authentication testing strategy: [Source: architecture/16-testing-strategy.md#test-organization]

- **API Tests**: tests/integration/api/auth.test.ts for authentication endpoints
- **Component Tests**: tests/unit/components/auth-form.test.tsx for auth forms
- **E2E Tests**: tests/e2e/auth.spec.ts for complete authentication flows
- **Hook Tests**: tests/unit/hooks/use-auth.test.ts for authentication hooks
- **Testing Frameworks**: Jest 29+ + React Testing Library for components, Supertest for API tests

### Technical Constraints

Authentication security requirements: [Source: architecture/17-coding-standards.md#critical-fullstack-rules]

- **Security First**: Never store sensitive information in client-side code, use HttpOnly cookies
- **Input Validation**: Use Zod for server-side validation of all auth inputs
- **Error Handling**: All auth API routes must use standard error handling patterns
- **Environment Variables**: Access Supabase keys only through configuration objects
- **Type Safety**: All auth components and APIs must use strict TypeScript typing

### Technology Stack Reference

Authentication stack components: [Source: architecture/3-tech-stack.md]

- **Authentication Service**: Supabase Auth for JWT token management and user authentication
- **Frontend Framework**: Next.js 14+ App Router for authentication pages and API routes
- **State Management**: Zustand for auth state persistence, React Query 5.0+ for server state
- **UI Components**: Chakra UI 2.8+ for form components, Tailwind CSS 3.4+ for styling
- **Validation**: Zod for input validation on both client and server sides

### Supabase Integration Details

Specific Supabase Auth implementation: [Source: architecture/11-backend-architecture.md#auth-architecture]

- **Client Configuration**: createServerComponentClient for server-side operations
- **Auth Flow**: Login request → Supabase verification → JWT generation → Session creation
- **Token Management**: Automatic token refresh with exponential backoff on failures
- **Route Protection**: Middleware pattern for protecting dashboard routes, redirecting unauthenticated users
- **Session Handling**: Real-time session state with automatic logout on token expiration

### Testing

Authentication testing requirements: [Source: architecture/16-testing-strategy.md]

- **Test File Location**: tests/ directory with unit/, integration/, e2e/ structure
- **Test Standards**: Jest + React Testing Library for auth components, Supertest for auth API routes
- **Testing Frameworks**: Jest 29+, React Testing Library, Playwright 1.40+
- **Specific Requirements**:
  - Component tests for login/register forms with validation scenarios
  - API integration tests for all auth endpoints including error cases
  - E2E tests for complete authentication flows including password reset
  - Hook tests for authentication state management and session handling

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-08-20 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
